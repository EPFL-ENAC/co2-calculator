<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=prev href=../backend/01-overview.html><link rel=next href=../infra/01-overview.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Overview - EPFL Project Technical Docs</title><link rel=stylesheet href=../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#database-overview class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title="EPFL Project Technical Docs" class="md-header__button md-logo" aria-label="EPFL Project Technical Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EPFL Project Technical Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Overview </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=cyan aria-hidden=true type=radio name=__palette id=__palette_0> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=cyan aria-hidden=true type=radio name=__palette id=__palette_1> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <div class=md-header__source> <a href=https://github.com/epfl-enac/co2-calculator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../index.html class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../architecture/index.html class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../architecture-decision-records/index.html class=md-tabs__link> Architecture Decision Records </a> </li> <li class=md-tabs__item> <a href=../frontend/01-overview.html class=md-tabs__link> Frontend </a> </li> <li class=md-tabs__item> <a href=../backend/01-overview.html class=md-tabs__link> Backend </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=01-overview.html class=md-tabs__link> Database </a> </li> <li class=md-tabs__item> <a href=../infra/01-overview.html class=md-tabs__link> Infrastructure </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title="EPFL Project Technical Docs" class="md-nav__button md-logo" aria-label="EPFL Project Technical Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> EPFL Project Technical Docs </label> <div class=md-nav__source> <a href=https://github.com/epfl-enac/co2-calculator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../architecture/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture/01-purpose-scope.html class=md-nav__link> <span class=md-ellipsis> Purpose & Scope </span> </a> </li> <li class=md-nav__item> <a href=../architecture/02-system-overview.html class=md-nav__link> <span class=md-ellipsis> System Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture/03-subsystem-map.html class=md-nav__link> <span class=md-ellipsis> Subsystem Map </span> </a> </li> <li class=md-nav__item> <a href=../architecture/04-auth-flow.html class=md-nav__link> <span class=md-ellipsis> Auth Flow </span> </a> </li> <li class=md-nav__item> <a href=../architecture/05-environments.html class=md-nav__link> <span class=md-ellipsis> Environments </span> </a> </li> <li class=md-nav__item> <a href=../architecture/06-cicd-pipeline.html class=md-nav__link> <span class=md-ellipsis> CI/CD Pipeline </span> </a> </li> <li class=md-nav__item> <a href=../architecture/07-global-conventions.html class=md-nav__link> <span class=md-ellipsis> Global Conventions </span> </a> </li> <li class=md-nav__item> <a href=../architecture/08-tech-stack.html class=md-nav__link> <span class=md-ellipsis> Tech Stack </span> </a> </li> <li class=md-nav__item> <a href=../architecture/09-component-breakdown.html class=md-nav__link> <span class=md-ellipsis> Component Breakdown </span> </a> </li> <li class=md-nav__item> <a href=../architecture/10-data-flow.html class=md-nav__link> <span class=md-ellipsis> Data Flow </span> </a> </li> <li class=md-nav__item> <a href=../architecture/11-deployment-topology.html class=md-nav__link> <span class=md-ellipsis> Deployment Topology </span> </a> </li> <li class=md-nav__item> <a href=../architecture/12-scalability.html class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> <li class=md-nav__item> <a href=../architecture/13-cross-cutting-concerns.html class=md-nav__link> <span class=md-ellipsis> Cross-Cutting Concerns </span> </a> </li> <li class=md-nav__item> <a href=../architecture/14-architectural-decisions.html class=md-nav__link> <span class=md-ellipsis> Architectural Decisions </span> </a> </li> <li class=md-nav__item> <a href=../architecture/15-appendices.html class=md-nav__link> <span class=md-ellipsis> Appendices </span> </a> </li> <li class=md-nav__item> <a href=../architecture/epfl-compliance-mapping.html class=md-nav__link> <span class=md-ellipsis> EPFL Compliance </span> </a> </li> <li class=md-nav__item> <a href=../architecture/code-standards.html class=md-nav__link> <span class=md-ellipsis> Code Standards </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Architecture Decision Records </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Architecture Decision Records </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../architecture-decision-records/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/001-python-package-manager.html class=md-nav__link> <span class=md-ellipsis> ADR-001 Python Package Manager </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/002-frontend-framework.html class=md-nav__link> <span class=md-ellipsis> ADR-002 Frontend Framework </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/003-backend-framework.html class=md-nav__link> <span class=md-ellipsis> ADR-003 Backend Framework </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/004-database-selection.html class=md-nav__link> <span class=md-ellipsis> ADR-004 Database Selection </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/005-authorization-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-005 Authorization Strategy </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/010-background-job-processing.html class=md-nav__link> <span class=md-ellipsis> ADR-010 Background Job Processing </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/012-jwt-authentication-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-012 JWT Authentication </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/013-object-storage-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-013 Object Storage </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Frontend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Frontend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../frontend/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Backend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Backend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../backend/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Database </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Database </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Overview </span> <span class="md-nav__icon md-icon"></span> </label> <a href=01-overview.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Overview </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#quick-reference class=md-nav__link> <span class=md-ellipsis> Quick Reference </span> </a> <nav class=md-nav aria-label="Quick Reference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#database-access class=md-nav__link> <span class=md-ellipsis> Database Access </span> </a> </li> <li class=md-nav__item> <a href=#common-operations class=md-nav__link> <span class=md-ellipsis> Common Operations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#database-technology class=md-nav__link> <span class=md-ellipsis> Database Technology </span> </a> <nav class=md-nav aria-label="Database Technology"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#key-postgresql-features-used class=md-nav__link> <span class=md-ellipsis> Key PostgreSQL Features Used </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schema-overview class=md-nav__link> <span class=md-ellipsis> Schema Overview </span> </a> <nav class=md-nav aria-label="Schema Overview"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#core-entities class=md-nav__link> <span class=md-ellipsis> Core Entities </span> </a> </li> <li class=md-nav__item> <a href=#entity-relationships class=md-nav__link> <span class=md-ellipsis> Entity Relationships </span> </a> </li> <li class=md-nav__item> <a href=#key-tables class=md-nav__link> <span class=md-ellipsis> Key Tables </span> </a> <nav class=md-nav aria-label="Key Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#users-table class=md-nav__link> <span class=md-ellipsis> Users Table </span> </a> </li> <li class=md-nav__item> <a href=#laboratories-table class=md-nav__link> <span class=md-ellipsis> Laboratories Table </span> </a> </li> <li class=md-nav__item> <a href=#import-jobs-table class=md-nav__link> <span class=md-ellipsis> Import Jobs Table </span> </a> </li> <li class=md-nav__item> <a href=#import-rows-table class=md-nav__link> <span class=md-ellipsis> Import Rows Table </span> </a> </li> <li class=md-nav__item> <a href=#activities-table class=md-nav__link> <span class=md-ellipsis> Activities Table </span> </a> </li> <li class=md-nav__item> <a href=#emission-factors-table class=md-nav__link> <span class=md-ellipsis> Emission Factors Table </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#migrations class=md-nav__link> <span class=md-ellipsis> Migrations </span> </a> <nav class=md-nav aria-label=Migrations> <ul class=md-nav__list> <li class=md-nav__item> <a href=#migration-process class=md-nav__link> <span class=md-ellipsis> Migration Process </span> </a> </li> <li class=md-nav__item> <a href=#creating-migrations class=md-nav__link> <span class=md-ellipsis> Creating Migrations </span> </a> </li> <li class=md-nav__item> <a href=#migration-naming-convention class=md-nav__link> <span class=md-ellipsis> Migration Naming Convention </span> </a> </li> <li class=md-nav__item> <a href=#migration-best-practices class=md-nav__link> <span class=md-ellipsis> Migration Best Practices </span> </a> </li> <li class=md-nav__item> <a href=#data-migrations class=md-nav__link> <span class=md-ellipsis> Data Migrations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backup-recovery class=md-nav__link> <span class=md-ellipsis> Backup &amp; Recovery </span> </a> <nav class=md-nav aria-label="Backup & Recovery"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#backup-strategy class=md-nav__link> <span class=md-ellipsis> Backup Strategy </span> </a> </li> <li class=md-nav__item> <a href=#restore-procedures class=md-nav__link> <span class=md-ellipsis> Restore Procedures </span> </a> </li> <li class=md-nav__item> <a href=#point-in-time-recovery-pitr class=md-nav__link> <span class=md-ellipsis> Point-in-Time Recovery (PITR) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-optimization class=md-nav__link> <span class=md-ellipsis> Performance Optimization </span> </a> <nav class=md-nav aria-label="Performance Optimization"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#indexes class=md-nav__link> <span class=md-ellipsis> Indexes </span> </a> </li> <li class=md-nav__item> <a href=#query-optimization class=md-nav__link> <span class=md-ellipsis> Query Optimization </span> </a> </li> <li class=md-nav__item> <a href=#connection-pooling class=md-nav__link> <span class=md-ellipsis> Connection Pooling </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#monitoring-maintenance class=md-nav__link> <span class=md-ellipsis> Monitoring &amp; Maintenance </span> </a> <nav class=md-nav aria-label="Monitoring & Maintenance"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#database-monitoring class=md-nav__link> <span class=md-ellipsis> Database Monitoring </span> </a> </li> <li class=md-nav__item> <a href=#routine-maintenance class=md-nav__link> <span class=md-ellipsis> Routine Maintenance </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#access-control class=md-nav__link> <span class=md-ellipsis> Access Control </span> </a> </li> <li class=md-nav__item> <a href=#data-encryption class=md-nav__link> <span class=md-ellipsis> Data Encryption </span> </a> </li> <li class=md-nav__item> <a href=#sensitive-data class=md-nav__link> <span class=md-ellipsis> Sensitive Data </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#connection-issues class=md-nav__link> <span class=md-ellipsis> Connection Issues </span> </a> </li> <li class=md-nav__item> <a href=#migration-issues class=md-nav__link> <span class=md-ellipsis> Migration Issues </span> </a> </li> <li class=md-nav__item> <a href=#performance-issues class=md-nav__link> <span class=md-ellipsis> Performance Issues </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> <nav class=md-nav aria-label="Additional Resources"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#architecture-documentation class=md-nav__link> <span class=md-ellipsis> Architecture Documentation </span> </a> </li> <li class=md-nav__item> <a href=#postgresql-documentation class=md-nav__link> <span class=md-ellipsis> PostgreSQL Documentation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Infrastructure </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../infra/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=database-overview>Database Overview<a class=headerlink href=#database-overview title="Permanent link">&para;</a></h1> <p>The database layer uses PostgreSQL for persistent data storage with SQLAlchemy ORM for data access. This overview provides schema information, migration procedures, and maintenance guidelines.</p> <p>For system architecture and technology decisions, see:</p> <ul> <li><a href=../architecture/09-component-breakdown.html>Component Breakdown</a> - Database layer architecture</li> <li><a href=../architecture/08-tech-stack.html>Tech Stack</a> - Why PostgreSQL</li> <li><a href=../architecture/10-data-flow.html>Data Flow</a> - Data movement patterns</li> <li><a href=../architecture-decision-records/004-database-selection.html>ADR-004 Database Selection</a> - Database decision</li> </ul> <hr> <h2 id=quick-reference>Quick Reference<a class=headerlink href=#quick-reference title="Permanent link">&para;</a></h2> <h3 id=database-access>Database Access<a class=headerlink href=#database-access title="Permanent link">&para;</a></h3> <p><strong>Development</strong>:</p> <div class=highlight><pre><span></span><code><span class=c1># Connect to local PostgreSQL (Docker Compose)</span>
docker-compose<span class=w> </span><span class=nb>exec</span><span class=w> </span>postgres<span class=w> </span>psql<span class=w> </span>-U<span class=w> </span>co2calculator<span class=w> </span>-d<span class=w> </span>co2calculator

<span class=c1># Or direct connection</span>
psql<span class=w> </span>postgresql://co2calculator:password@localhost:5432/co2calculator
</code></pre></div> <p><strong>Production</strong>: Access via Kubernetes port-forwarding or admin tools</p> <h3 id=common-operations>Common Operations<a class=headerlink href=#common-operations title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Run migrations</span>
<span class=nb>cd</span><span class=w> </span>backend
make<span class=w> </span>db-migrate

<span class=c1># Create new migration</span>
make<span class=w> </span>db-revision<span class=w> </span><span class=nv>message</span><span class=o>=</span><span class=s2>&quot;Add user preferences&quot;</span>

<span class=c1># Rollback one migration</span>
make<span class=w> </span>db-downgrade

<span class=c1># View migration history</span>
make<span class=w> </span>db-history

<span class=c1># Database backup (production)</span>
kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-n<span class=w> </span>co2calculator<span class=w> </span>postgres-0<span class=w> </span>--<span class=w> </span>pg_dump<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>co2calculator<span class=w> </span>&gt;<span class=w> </span>backup.sql
</code></pre></div> <hr> <h2 id=database-technology>Database Technology<a class=headerlink href=#database-technology title="Permanent link">&para;</a></h2> <ul> <li><strong>Engine</strong>: PostgreSQL 15+</li> <li><strong>ORM</strong>: SQLAlchemy 2.0</li> <li><strong>Migration Tool</strong>: Alembic</li> <li><strong>Connection Pooling</strong>: PgBouncer (production) or SQLAlchemy pooling (development)</li> <li><strong>Backup</strong>: pg_dump + S3/RCP NAS storage</li> </ul> <h3 id=key-postgresql-features-used>Key PostgreSQL Features Used<a class=headerlink href=#key-postgresql-features-used title="Permanent link">&para;</a></h3> <ul> <li><strong>JSONB</strong>: Flexible data structures (import row validation errors)</li> <li><strong>ARRAY</strong>: Multi-value columns (user roles, lab members)</li> <li><strong>Full-Text Search</strong>: Search across labs and emission factors</li> <li><strong>Partial Indexes</strong>: Optimize queries on filtered data</li> <li><strong>Foreign Key Constraints</strong>: Enforce referential integrity</li> <li><strong>Check Constraints</strong>: Enforce business rules at DB level</li> </ul> <hr> <h2 id=schema-overview>Schema Overview<a class=headerlink href=#schema-overview title="Permanent link">&para;</a></h2> <h3 id=core-entities>Core Entities<a class=headerlink href=#core-entities title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>Users
├── Laboratories (created_by)
│   ├── ImportJobs (lab_id)
│   │   └── ImportRows (import_job_id)
│   ├── Activities (lab_id)
│   └── Results (lab_id)
├── AuditLogs (user_id)
└── UserRoles (user_id)

EmissionFactors (standalone, referenced by Activities)
├── TravelFactors
├── EnergyFactors
├── PurchaseFactors
└── CustomFactors
</code></pre></div> <h3 id=entity-relationships>Entity Relationships<a class=headerlink href=#entity-relationships title="Permanent link">&para;</a></h3> <ul> <li><strong>Users ↔ Laboratories</strong>: One-to-Many (user creates many labs)</li> <li><strong>Laboratories ↔ ImportJobs</strong>: One-to-Many (lab has many imports)</li> <li><strong>ImportJobs ↔ ImportRows</strong>: One-to-Many (import has many rows)</li> <li><strong>Laboratories ↔ Activities</strong>: One-to-Many (lab has many activities)</li> <li><strong>Activities → EmissionFactors</strong>: Many-to-One (many activities use one factor)</li> </ul> <h3 id=key-tables>Key Tables<a class=headerlink href=#key-tables title="Permanent link">&para;</a></h3> <h4 id=users-table>Users Table<a class=headerlink href=#users-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>sciper</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>  </span><span class=c1>-- EPFL unique identifier</span>
<span class=w>    </span><span class=n>email</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>display_name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span>
<span class=w>    </span><span class=n>roles</span><span class=w> </span><span class=nb>TEXT</span><span class=p>[]</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=nb>ARRAY</span><span class=p>[</span><span class=s1>&#39;viewer&#39;</span><span class=p>],</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>(),</span>
<span class=w>    </span><span class=n>updated_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_users_sciper</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>sciper</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_users_email</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>email</span><span class=p>);</span>
</code></pre></div> <h4 id=laboratories-table>Laboratories Table<a class=headerlink href=#laboratories-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>laboratories</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>code</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>  </span><span class=c1>-- Lab code (e.g., ENAC-IIE)</span>
<span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>faculty</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<span class=w>    </span><span class=n>created_by</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>(),</span>
<span class=w>    </span><span class=n>updated_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_labs_created_by</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>laboratories</span><span class=p>(</span><span class=n>created_by</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_labs_faculty</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>laboratories</span><span class=p>(</span><span class=n>faculty</span><span class=p>);</span>
</code></pre></div> <h4 id=import-jobs-table>Import Jobs Table<a class=headerlink href=#import-jobs-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>import_jobs</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>lab_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>laboratories</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span>
<span class=w>    </span><span class=n>uploader_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
<span class=w>    </span><span class=n>filename</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>s3_key</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>500</span><span class=p>),</span><span class=w>  </span><span class=c1>-- S3 object key</span>
<span class=w>    </span><span class=n>status</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;pending&#39;</span><span class=p>,</span><span class=w>  </span><span class=c1>-- pending, processing, completed, failed</span>
<span class=w>    </span><span class=n>rows_total</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=n>rows_valid</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=n>rows_error</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>(),</span>
<span class=w>    </span><span class=n>completed_at</span><span class=w> </span><span class=k>TIMESTAMP</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_imports_lab_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>import_jobs</span><span class=p>(</span><span class=n>lab_id</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_imports_status</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>import_jobs</span><span class=p>(</span><span class=n>status</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_imports_created_at</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>import_jobs</span><span class=p>(</span><span class=n>created_at</span><span class=w> </span><span class=k>DESC</span><span class=p>);</span>
</code></pre></div> <h4 id=import-rows-table>Import Rows Table<a class=headerlink href=#import-rows-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>import_rows</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>import_job_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>import_jobs</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span>
<span class=w>    </span><span class=n>row_number</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>raw_data</span><span class=w> </span><span class=n>JSONB</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>  </span><span class=c1>-- Original CSV row data</span>
<span class=w>    </span><span class=n>validation_errors</span><span class=w> </span><span class=n>JSONB</span><span class=p>,</span><span class=w>   </span><span class=c1>-- Array of validation error messages</span>
<span class=w>    </span><span class=n>status</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;valid&#39;</span><span class=p>,</span><span class=w>  </span><span class=c1>-- valid, error</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_import_rows_job</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>import_rows</span><span class=p>(</span><span class=n>import_job_id</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_import_rows_status</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>import_rows</span><span class=p>(</span><span class=n>status</span><span class=p>);</span>
</code></pre></div> <h4 id=activities-table>Activities Table<a class=headerlink href=#activities-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>activities</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>lab_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>laboratories</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span>
<span class=w>    </span><span class=n>import_row_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>import_rows</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
<span class=w>    </span><span class=n>activity_type</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>  </span><span class=c1>-- travel, energy, purchase, service</span>
<span class=w>    </span><span class=n>category</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<span class=w>    </span><span class=n>subcategory</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<span class=w>    </span><span class=n>quantity</span><span class=w> </span><span class=nb>NUMERIC</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>unit</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>emission_factor_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>emission_factors</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
<span class=w>    </span><span class=n>co2e_kg</span><span class=w> </span><span class=nb>NUMERIC</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>),</span><span class=w>  </span><span class=c1>-- Calculated CO2 equivalent</span>
<span class=w>    </span><span class=nb>date</span><span class=w> </span><span class=nb>DATE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_lab</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>activities</span><span class=p>(</span><span class=n>lab_id</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_type</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>activities</span><span class=p>(</span><span class=n>activity_type</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_date</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>activities</span><span class=p>(</span><span class=nb>date</span><span class=w> </span><span class=k>DESC</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_factor</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>activities</span><span class=p>(</span><span class=n>emission_factor_id</span><span class=p>);</span>
</code></pre></div> <h4 id=emission-factors-table>Emission Factors Table<a class=headerlink href=#emission-factors-table title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>emission_factors</span><span class=w> </span><span class=p>(</span>
<span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
<span class=w>    </span><span class=n>code</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>category</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=n>subcategory</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<span class=w>    </span><span class=n>value</span><span class=w> </span><span class=nb>NUMERIC</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>  </span><span class=c1>-- kg CO2e per unit</span>
<span class=w>    </span><span class=n>unit</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<span class=w>    </span><span class=k>source</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>  </span><span class=c1>-- Data source (DEFRA, ADEME, custom)</span>
<span class=w>    </span><span class=n>valid_from</span><span class=w> </span><span class=nb>DATE</span><span class=p>,</span>
<span class=w>    </span><span class=n>valid_to</span><span class=w> </span><span class=nb>DATE</span><span class=p>,</span>
<span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>(),</span>
<span class=w>    </span><span class=n>updated_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span>
<span class=p>);</span>

<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_factors_code</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>emission_factors</span><span class=p>(</span><span class=n>code</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_factors_category</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>emission_factors</span><span class=p>(</span><span class=n>category</span><span class=p>);</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_factors_valid</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>emission_factors</span><span class=p>(</span><span class=n>valid_from</span><span class=p>,</span><span class=w> </span><span class=n>valid_to</span><span class=p>);</span>
</code></pre></div> <p><strong>Full Schema</strong>: See <a href=https://github.com/EPFL-ENAC/co2-calculator/tree/main/backend/app/models><code>backend/app/models/</code></a> for SQLAlchemy model definitions.</p> <hr> <h2 id=migrations>Migrations<a class=headerlink href=#migrations title="Permanent link">&para;</a></h2> <h3 id=migration-process>Migration Process<a class=headerlink href=#migration-process title="Permanent link">&para;</a></h3> <ol> <li><strong>Make schema changes</strong> in SQLAlchemy models (<code>backend/app/models/*.py</code>)</li> <li><strong>Generate migration</strong> with Alembic auto-detection</li> <li><strong>Review and customize</strong> the generated migration script</li> <li><strong>Test locally</strong> (apply and rollback)</li> <li><strong>Commit</strong> migration script to version control</li> <li><strong>Apply</strong> to test/staging/production environments</li> </ol> <h3 id=creating-migrations>Creating Migrations<a class=headerlink href=#creating-migrations title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Generate migration from model changes</span>
<span class=nb>cd</span><span class=w> </span>backend
alembic<span class=w> </span>revision<span class=w> </span>--autogenerate<span class=w> </span>-m<span class=w> </span><span class=s2>&quot;Add user preferences table&quot;</span>

<span class=c1># Review generated file: alembic/versions/XXXX_add_user_preferences_table.py</span>

<span class=c1># Apply migration</span>
alembic<span class=w> </span>upgrade<span class=w> </span>head

<span class=c1># Rollback if needed</span>
alembic<span class=w> </span>downgrade<span class=w> </span>-1
</code></pre></div> <h3 id=migration-naming-convention>Migration Naming Convention<a class=headerlink href=#migration-naming-convention title="Permanent link">&para;</a></h3> <p>Format: <code>{revision}_{description}.py</code></p> <p>Examples:</p> <ul> <li><code>001_initial_schema.py</code></li> <li><code>002_add_user_roles.py</code></li> <li><code>003_add_import_validation.py</code></li> </ul> <h3 id=migration-best-practices>Migration Best Practices<a class=headerlink href=#migration-best-practices title="Permanent link">&para;</a></h3> <ul> <li><strong>One purpose per migration</strong>: Don't mix unrelated changes</li> <li><strong>Always test downgrade</strong>: Ensure migrations are reversible</li> <li><strong>Handle data carefully</strong>: Use separate data migrations for large datasets</li> <li><strong>Avoid destructive changes</strong>: Don't drop columns with data (deprecate instead)</li> <li><strong>Version control</strong>: Always commit migrations with code changes</li> </ul> <h3 id=data-migrations>Data Migrations<a class=headerlink href=#data-migrations title="Permanent link">&para;</a></h3> <p>For complex data transformations, create data-only migrations:</p> <div class=highlight><pre><span></span><code><span class=c1># alembic/versions/004_migrate_old_factor_format.py</span>
<span class=k>def</span><span class=w> </span><span class=nf>upgrade</span><span class=p>():</span>
    <span class=n>op</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>        UPDATE emission_factors</span>
<span class=s2>        SET value = value * 1000</span>
<span class=s2>        WHERE unit = &#39;tonnes&#39;</span>
<span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>

    <span class=n>op</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>        UPDATE emission_factors</span>
<span class=s2>        SET unit = &#39;kg&#39;</span>
<span class=s2>        WHERE unit = &#39;tonnes&#39;</span>
<span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>

<span class=k>def</span><span class=w> </span><span class=nf>downgrade</span><span class=p>():</span>
    <span class=n>op</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>        UPDATE emission_factors</span>
<span class=s2>        SET value = value / 1000</span>
<span class=s2>        WHERE unit = &#39;kg&#39; AND value &gt; 1000</span>
<span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>

    <span class=n>op</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>        UPDATE emission_factors</span>
<span class=s2>        SET unit = &#39;tonnes&#39;</span>
<span class=s2>        WHERE unit = &#39;kg&#39; AND value &lt; 1</span>
<span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>
</code></pre></div> <hr> <h2 id=backup-recovery>Backup &amp; Recovery<a class=headerlink href=#backup-recovery title="Permanent link">&para;</a></h2> <h3 id=backup-strategy>Backup Strategy<a class=headerlink href=#backup-strategy title="Permanent link">&para;</a></h3> <p><strong>Automated Backups</strong> (Production):</p> <ul> <li><strong>Full backup</strong>: Daily at 02:00 UTC</li> <li><strong>Incremental backup</strong>: Every 6 hours</li> <li><strong>Transaction logs</strong>: Continuous archiving</li> <li><strong>Retention</strong>: 30 days on RCP NAS, 1 year archived to S3</li> </ul> <p><strong>Manual Backups</strong>:</p> <div class=highlight><pre><span></span><code><span class=c1># Full database backup</span>
pg_dump<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>-F<span class=w> </span>c<span class=w> </span>-f<span class=w> </span>backup_<span class=k>$(</span>date<span class=w> </span>+%Y%m%d<span class=k>)</span>.dump

<span class=c1># Schema-only backup</span>
pg_dump<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>--schema-only<span class=w> </span>-f<span class=w> </span>schema.sql

<span class=c1># Data-only backup</span>
pg_dump<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>--data-only<span class=w> </span>-f<span class=w> </span>data.sql

<span class=c1># Specific table backup</span>
pg_dump<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>-t<span class=w> </span>activities<span class=w> </span>-F<span class=w> </span>c<span class=w> </span>-f<span class=w> </span>activities_backup.dump
</code></pre></div> <h3 id=restore-procedures>Restore Procedures<a class=headerlink href=#restore-procedures title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Restore full database</span>
pg_restore<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>-c<span class=w> </span>backup.dump

<span class=c1># Restore specific table</span>
pg_restore<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>-t<span class=w> </span>activities<span class=w> </span>activities_backup.dump

<span class=c1># Restore from SQL file</span>
psql<span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>co2calculator<span class=w> </span>-f<span class=w> </span>backup.sql
</code></pre></div> <h3 id=point-in-time-recovery-pitr>Point-in-Time Recovery (PITR)<a class=headerlink href=#point-in-time-recovery-pitr title="Permanent link">&para;</a></h3> <p>PostgreSQL WAL archiving enables recovery to any point in time:</p> <div class=highlight><pre><span></span><code><span class=c1># Restore to specific time</span>
<span class=nv>recovery_target_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2025-11-10 14:30:00&#39;</span>
</code></pre></div> <p><strong>Configuration</strong>: See infrastructure team for PITR setup (requires WAL archiving).</p> <hr> <h2 id=performance-optimization>Performance Optimization<a class=headerlink href=#performance-optimization title="Permanent link">&para;</a></h2> <h3 id=indexes>Indexes<a class=headerlink href=#indexes title="Permanent link">&para;</a></h3> <p>Indexes are automatically created for:</p> <ul> <li>Primary keys (<code>id</code> columns)</li> <li>Foreign keys (<code>*_id</code> columns)</li> <li>Unique constraints (<code>sciper</code>, <code>email</code>, <code>code</code>)</li> </ul> <p><strong>Custom indexes</strong>:</p> <div class=highlight><pre><span></span><code><span class=c1>-- Speed up lab activity queries</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_lab_date</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>activities</span><span class=p>(</span><span class=n>lab_id</span><span class=p>,</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=k>DESC</span><span class=p>);</span>

<span class=c1>-- Speed up import status filtering</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_imports_status_created</span>
<span class=k>ON</span><span class=w> </span><span class=n>import_jobs</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>created_at</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span>
<span class=k>WHERE</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>;</span>
</code></pre></div> <h3 id=query-optimization>Query Optimization<a class=headerlink href=#query-optimization title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># ❌ Bad: N+1 queries</span>
<span class=n>labs</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Lab</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
<span class=k>for</span> <span class=n>lab</span> <span class=ow>in</span> <span class=n>labs</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>lab</span><span class=o>.</span><span class=n>created_by</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>  <span class=c1># Separate query for each lab</span>

<span class=c1># ✅ Good: Eager loading</span>
<span class=n>labs</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Lab</span><span class=p>)</span><span class=o>.</span><span class=n>options</span><span class=p>(</span>
    <span class=n>joinedload</span><span class=p>(</span><span class=n>Lab</span><span class=o>.</span><span class=n>created_by</span><span class=p>)</span>
<span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
<span class=k>for</span> <span class=n>lab</span> <span class=ow>in</span> <span class=n>labs</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>lab</span><span class=o>.</span><span class=n>created_by</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>  <span class=c1># No additional queries</span>
</code></pre></div> <h3 id=connection-pooling>Connection Pooling<a class=headerlink href=#connection-pooling title="Permanent link">&para;</a></h3> <p><strong>Development</strong>: SQLAlchemy default pool (5 connections)</p> <p><strong>Production</strong>: PgBouncer for connection pooling</p> <div class=highlight><pre><span></span><code><span class=c1># PgBouncer configuration</span>
<span class=k>[databases]</span>
<span class=na>co2calculator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>host=postgres port=5432 dbname=co2calculator</span>

<span class=k>[pgbouncer]</span>
<span class=na>pool_mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>transaction</span>
<span class=na>max_client_conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>1000</span>
<span class=na>default_pool_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>25</span>
<span class=na>reserve_pool_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>5</span>
</code></pre></div> <hr> <h2 id=monitoring-maintenance>Monitoring &amp; Maintenance<a class=headerlink href=#monitoring-maintenance title="Permanent link">&para;</a></h2> <h3 id=database-monitoring>Database Monitoring<a class=headerlink href=#database-monitoring title="Permanent link">&para;</a></h3> <p><strong>Metrics to track</strong>:</p> <ul> <li>Connection count (<code>pg_stat_activity</code>)</li> <li>Query performance (<code>pg_stat_statements</code>)</li> <li>Table sizes (<code>pg_relation_size</code>)</li> <li>Index usage (<code>pg_stat_user_indexes</code>)</li> <li>Bloat (dead tuples)</li> </ul> <p><strong>Queries</strong>:</p> <div class=highlight><pre><span></span><code><span class=c1>-- Active connections</span>
<span class=k>SELECT</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_stat_activity</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;active&#39;</span><span class=p>;</span>

<span class=c1>-- Slow queries</span>
<span class=k>SELECT</span><span class=w> </span><span class=n>query</span><span class=p>,</span><span class=w> </span><span class=n>mean_exec_time</span>
<span class=k>FROM</span><span class=w> </span><span class=n>pg_stat_statements</span>
<span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>mean_exec_time</span><span class=w> </span><span class=k>DESC</span>
<span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>

<span class=c1>-- Table sizes</span>
<span class=k>SELECT</span><span class=w> </span><span class=n>relname</span><span class=p>,</span><span class=w> </span><span class=n>pg_size_pretty</span><span class=p>(</span><span class=n>pg_relation_size</span><span class=p>(</span><span class=n>relid</span><span class=p>))</span>
<span class=k>FROM</span><span class=w> </span><span class=n>pg_stat_user_tables</span>
<span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>pg_relation_size</span><span class=p>(</span><span class=n>relid</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>

<span class=c1>-- Unused indexes</span>
<span class=k>SELECT</span><span class=w> </span><span class=n>schemaname</span><span class=p>,</span><span class=w> </span><span class=n>tablename</span><span class=p>,</span><span class=w> </span><span class=n>indexname</span>
<span class=k>FROM</span><span class=w> </span><span class=n>pg_stat_user_indexes</span>
<span class=k>WHERE</span><span class=w> </span><span class=n>idx_scan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=k>AND</span><span class=w> </span><span class=n>indexname</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;%_pkey&#39;</span><span class=p>;</span>
</code></pre></div> <h3 id=routine-maintenance>Routine Maintenance<a class=headerlink href=#routine-maintenance title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1>-- Vacuum and analyze (reclaim space, update statistics)</span>
<span class=k>VACUUM</span><span class=w> </span><span class=k>ANALYZE</span><span class=p>;</span>

<span class=c1>-- Rebuild index</span>
<span class=k>REINDEX</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_activities_lab_date</span><span class=p>;</span>

<span class=c1>-- Check for bloat</span>
<span class=k>SELECT</span><span class=w> </span><span class=n>schemaname</span><span class=p>,</span><span class=w> </span><span class=n>tablename</span><span class=p>,</span>
<span class=w>       </span><span class=n>pg_size_pretty</span><span class=p>(</span><span class=n>pg_total_relation_size</span><span class=p>(</span><span class=n>schemaname</span><span class=o>||</span><span class=s1>&#39;.&#39;</span><span class=o>||</span><span class=n>tablename</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>size</span>
<span class=k>FROM</span><span class=w> </span><span class=n>pg_tables</span>
<span class=k>WHERE</span><span class=w> </span><span class=n>schemaname</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;public&#39;</span>
<span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>pg_total_relation_size</span><span class=p>(</span><span class=n>schemaname</span><span class=o>||</span><span class=s1>&#39;.&#39;</span><span class=o>||</span><span class=n>tablename</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</code></pre></div> <p><strong>Automated Maintenance</strong>: PostgreSQL autovacuum handles routine maintenance automatically.</p> <hr> <h2 id=security>Security<a class=headerlink href=#security title="Permanent link">&para;</a></h2> <h3 id=access-control>Access Control<a class=headerlink href=#access-control title="Permanent link">&para;</a></h3> <ul> <li><strong>Application user</strong>: Limited permissions (CRUD on application tables)</li> <li><strong>Admin user</strong>: Full database access (for migrations, backups)</li> <li><strong>Read-only user</strong>: SELECT only (for reporting, analytics)</li> </ul> <div class=highlight><pre><span></span><code><span class=c1>-- Create application user</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=n>co2calculator_app</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>PASSWORD</span><span class=w> </span><span class=s1>&#39;strong_password&#39;</span><span class=p>;</span>
<span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=p>,</span><span class=w> </span><span class=k>INSERT</span><span class=p>,</span><span class=w> </span><span class=k>UPDATE</span><span class=p>,</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>ALL</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>co2calculator_app</span><span class=p>;</span>

<span class=c1>-- Create read-only user</span>
<span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=n>co2calculator_readonly</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>PASSWORD</span><span class=w> </span><span class=s1>&#39;readonly_password&#39;</span><span class=p>;</span>
<span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>ALL</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>co2calculator_readonly</span><span class=p>;</span>
</code></pre></div> <h3 id=data-encryption>Data Encryption<a class=headerlink href=#data-encryption title="Permanent link">&para;</a></h3> <ul> <li><strong>At rest</strong>: PostgreSQL supports transparent data encryption (TDE)</li> <li><strong>In transit</strong>: SSL/TLS connections required in production</li> <li><strong>Connection string</strong>: <code>postgresql://user:pass@host:5432/db?sslmode=require</code></li> </ul> <h3 id=sensitive-data>Sensitive Data<a class=headerlink href=#sensitive-data title="Permanent link">&para;</a></h3> <ul> <li><strong>Passwords</strong>: Never stored in database (authentication via OIDC)</li> <li><strong>PII</strong>: User email and SCIPER (encrypted backups)</li> <li><strong>Audit logs</strong>: Track data access and modifications</li> </ul> <hr> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h2> <h3 id=connection-issues>Connection Issues<a class=headerlink href=#connection-issues title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Check PostgreSQL is running</span>
docker-compose<span class=w> </span>ps<span class=w> </span>postgres

<span class=c1># Check connection from backend</span>
psql<span class=w> </span><span class=nv>$DATABASE_URL</span><span class=w> </span>-c<span class=w> </span><span class=s2>&quot;SELECT 1;&quot;</span>

<span class=c1># View connection errors in logs</span>
docker-compose<span class=w> </span>logs<span class=w> </span>postgres<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>ERROR
</code></pre></div> <h3 id=migration-issues>Migration Issues<a class=headerlink href=#migration-issues title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Check current migration version</span>
alembic<span class=w> </span>current

<span class=c1># View migration history</span>
alembic<span class=w> </span><span class=nb>history</span>

<span class=c1># Force set version (if out of sync)</span>
alembic<span class=w> </span>stamp<span class=w> </span>head

<span class=c1># Rollback problematic migration</span>
alembic<span class=w> </span>downgrade<span class=w> </span>-1
</code></pre></div> <h3 id=performance-issues>Performance Issues<a class=headerlink href=#performance-issues title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Check for blocking queries</span>
SELECT<span class=w> </span>pid,<span class=w> </span>query,<span class=w> </span>state
FROM<span class=w> </span>pg_stat_activity
WHERE<span class=w> </span><span class=nv>wait_event_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Lock&#39;</span><span class=p>;</span>

<span class=c1># Kill blocking query (if needed)</span>
SELECT<span class=w> </span>pg_terminate_backend<span class=o>(</span>pid<span class=o>)</span><span class=p>;</span>

<span class=c1># Check table bloat</span>
VACUUM<span class=w> </span>VERBOSE<span class=w> </span>ANALYZE<span class=w> </span>activities<span class=p>;</span>
</code></pre></div> <hr> <h2 id=additional-resources>Additional Resources<a class=headerlink href=#additional-resources title="Permanent link">&para;</a></h2> <h3 id=architecture-documentation>Architecture Documentation<a class=headerlink href=#architecture-documentation title="Permanent link">&para;</a></h3> <ul> <li><a href=../architecture/02-system-overview.html>System Overview</a> - Database in system context</li> <li><a href=../architecture/10-data-flow.html>Data Flow</a> - How data moves through the system</li> <li><a href=../architecture/09-component-breakdown.html#database-layer>Component Breakdown</a> - Database architecture</li> </ul> <h3 id=postgresql-documentation>PostgreSQL Documentation<a class=headerlink href=#postgresql-documentation title="Permanent link">&para;</a></h3> <ul> <li><a href=https://www.postgresql.org/docs/ >PostgreSQL Official Docs</a></li> <li><a href=https://docs.sqlalchemy.org/en/20/ >SQLAlchemy ORM</a></li> <li><a href=https://alembic.sqlalchemy.org/ >Alembic Migrations</a></li> </ul> <hr> <p><strong>Last Updated</strong>: November 11, 2025<br> <strong>Readable in</strong>: ~8 minutes</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 11, 2025 10:45:10 CET">November 11, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Contributors> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg> </span> <nav> <a href=mailto:pierre.guilbert@epfl.ch>Guilbert Pierre</a> </nav> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> 2025 EPFL — GPL-3.0 License. Built with MkDocs </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "content.code.annotate", "navigation.instant", "navigation.instant.prefetch"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "1.0.0"}</script> <script src=../assets/javascripts/bundle.f55a23d4.min.js></script> </body> </html>