<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Backend Architecture - EPFL Project Technical Docs</title><link rel=stylesheet href=../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#backend-architecture class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title="EPFL Project Technical Docs" class="md-header__button md-logo" aria-label="EPFL Project Technical Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EPFL Project Technical Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Backend Architecture </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=cyan aria-hidden=true type=radio name=__palette id=__palette_0> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=cyan aria-hidden=true type=radio name=__palette id=__palette_1> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <div class=md-header__source> <a href=https://github.com/epfl-enac/co2-calculator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../index.html class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../architecture/index.html class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../architecture-decision-records/index.html class=md-tabs__link> Architecture Decision Records </a> </li> <li class=md-tabs__item> <a href=../frontend/01-overview.html class=md-tabs__link> Frontend </a> </li> <li class=md-tabs__item> <a href=01-overview.html class=md-tabs__link> Backend </a> </li> <li class=md-tabs__item> <a href=../database/01-overview.html class=md-tabs__link> Database </a> </li> <li class=md-tabs__item> <a href=../infra/01-overview.html class=md-tabs__link> Infrastructure </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title="EPFL Project Technical Docs" class="md-nav__button md-logo" aria-label="EPFL Project Technical Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> EPFL Project Technical Docs </label> <div class=md-nav__source> <a href=https://github.com/epfl-enac/co2-calculator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../architecture/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture/01-purpose-scope.html class=md-nav__link> <span class=md-ellipsis> Purpose & Scope </span> </a> </li> <li class=md-nav__item> <a href=../architecture/02-system-overview.html class=md-nav__link> <span class=md-ellipsis> System Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture/03-subsystem-map.html class=md-nav__link> <span class=md-ellipsis> Subsystem Map </span> </a> </li> <li class=md-nav__item> <a href=../architecture/04-auth-flow.html class=md-nav__link> <span class=md-ellipsis> Auth Flow </span> </a> </li> <li class=md-nav__item> <a href=../architecture/05-environments.html class=md-nav__link> <span class=md-ellipsis> Environments </span> </a> </li> <li class=md-nav__item> <a href=../architecture/06-cicd-pipeline.html class=md-nav__link> <span class=md-ellipsis> CI/CD Pipeline </span> </a> </li> <li class=md-nav__item> <a href=../architecture/07-global-conventions.html class=md-nav__link> <span class=md-ellipsis> Global Conventions </span> </a> </li> <li class=md-nav__item> <a href=../architecture/08-tech-stack.html class=md-nav__link> <span class=md-ellipsis> Tech Stack </span> </a> </li> <li class=md-nav__item> <a href=../architecture/09-component-breakdown.html class=md-nav__link> <span class=md-ellipsis> Component Breakdown </span> </a> </li> <li class=md-nav__item> <a href=../architecture/10-data-flow.html class=md-nav__link> <span class=md-ellipsis> Data Flow </span> </a> </li> <li class=md-nav__item> <a href=../architecture/11-deployment-topology.html class=md-nav__link> <span class=md-ellipsis> Deployment Topology </span> </a> </li> <li class=md-nav__item> <a href=../architecture/12-scalability.html class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> <li class=md-nav__item> <a href=../architecture/13-cross-cutting-concerns.html class=md-nav__link> <span class=md-ellipsis> Cross-Cutting Concerns </span> </a> </li> <li class=md-nav__item> <a href=../architecture/14-architectural-decisions.html class=md-nav__link> <span class=md-ellipsis> Architectural Decisions </span> </a> </li> <li class=md-nav__item> <a href=../architecture/15-appendices.html class=md-nav__link> <span class=md-ellipsis> Appendices </span> </a> </li> <li class=md-nav__item> <a href=../architecture/epfl-compliance-mapping.html class=md-nav__link> <span class=md-ellipsis> EPFL Compliance </span> </a> </li> <li class=md-nav__item> <a href=../architecture/code-standards.html class=md-nav__link> <span class=md-ellipsis> Code Standards </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Architecture Decision Records </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Architecture Decision Records </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../architecture-decision-records/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/001-python-package-manager.html class=md-nav__link> <span class=md-ellipsis> ADR-001 Python Package Manager </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/002-frontend-framework.html class=md-nav__link> <span class=md-ellipsis> ADR-002 Frontend Framework </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/003-backend-framework.html class=md-nav__link> <span class=md-ellipsis> ADR-003 Backend Framework </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/004-database-selection.html class=md-nav__link> <span class=md-ellipsis> ADR-004 Database Selection </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/005-authorization-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-005 Authorization Strategy </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/010-background-job-processing.html class=md-nav__link> <span class=md-ellipsis> ADR-010 Background Job Processing </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/012-jwt-authentication-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-012 JWT Authentication </span> </a> </li> <li class=md-nav__item> <a href=../architecture-decision-records/013-object-storage-strategy.html class=md-nav__link> <span class=md-ellipsis> ADR-013 Object Storage </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Frontend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Frontend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../frontend/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Backend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Backend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Database </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Database </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../database/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Infrastructure </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../infra/01-overview.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=backend-architecture>Backend Architecture<a class=headerlink href=#backend-architecture title="Permanent link">&para;</a></h1> <p>This document describes the layered architecture of the CO2 Calculator backend. The system uses FastAPI with clean separation between API handling, business logic, and data access. Read this to understand how layers interact and where to place new code.</p> <h2 id=layer-overview>Layer Overview<a class=headerlink href=#layer-overview title="Permanent link">&para;</a></h2> <p>The backend uses five distinct layers, each with a single responsibility:</p> <div class=highlight><pre><span></span><code>┌─────────────────────────────────────┐
│     API Layer (app/api/)            │
│     HTTP routing, validation        │
├─────────────────────────────────────┤
│     Service Layer (app/services/)   │
│     Business logic, authorization   │
├─────────────────────────────────────┤
│  Repository Layer (app/repositories/)│
│     Database queries, filters       │
├─────────────────────────────────────┤
│     Models Layer (app/models/)      │
│     SQLAlchemy ORM definitions      │
└─────────────────────────────────────┘

      Cross-Cutting (app/core/)
      Config, Security, Logging
</code></pre></div> <h2 id=api-layer>API Layer<a class=headerlink href=#api-layer title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/api/</code></p> <p><strong>Purpose</strong>: Handle HTTP requests and responses</p> <p>Handle HTTP-specific concerns like routing, validation, and serialization. Extract user context from JWT tokens and pass to services.</p> <p><strong>Example</strong>:</p> <div class=highlight><pre><span></span><code><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/resources&quot;</span><span class=p>)</span>
<span class=k>def</span><span class=w> </span><span class=nf>list_resources</span><span class=p>(</span>
    <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>),</span>
    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)</span>
<span class=p>):</span>
    <span class=k>return</span> <span class=n>resource_service</span><span class=o>.</span><span class=n>list_resources</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>user</span><span class=p>)</span>
</code></pre></div> <p><strong>Key Files</strong>:</p> <ul> <li><code>router.py</code> - Aggregates all API routers</li> <li><code>deps.py</code> - Reusable dependencies (get_db, get_current_user)</li> <li><code>v1/resources.py</code> - Resource CRUD endpoints</li> <li><code>v1/users.py</code> - User endpoints</li> </ul> <h2 id=service-layer>Service Layer<a class=headerlink href=#service-layer title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/services/</code></p> <p><strong>Purpose</strong>: Implement business logic and authorization</p> <p>Orchestrate repository calls, apply business rules, and check permissions. Authorization happens here before data access.</p> <p><strong>Example</strong>:</p> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>list_resources</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
    <span class=c1># Check permissions</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=o>.</span><span class=n>has_permission</span><span class=p>(</span><span class=s2>&quot;resource.read&quot;</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>PermissionDenied</span><span class=p>()</span>

    <span class=c1># Build filters based on user context</span>
    <span class=n>filters</span> <span class=o>=</span> <span class=n>get_filters_for_user</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>

    <span class=c1># Query database with filters</span>
    <span class=k>return</span> <span class=n>resource_repo</span><span class=o>.</span><span class=n>get_resources</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>filters</span><span class=o>=</span><span class=n>filters</span><span class=p>)</span>
</code></pre></div> <p><strong>Key Files</strong>:</p> <ul> <li><code>user_service.py</code> - User management logic</li> <li><code>resource_service.py</code> - Resource logic with authorization</li> </ul> <h2 id=repository-layer>Repository Layer<a class=headerlink href=#repository-layer title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/repositories/</code></p> <p><strong>Purpose</strong>: Execute database queries</p> <p>Handle pure data access without business logic. Accept filters from services and apply them to queries. No authorization logic here.</p> <p><strong>Example</strong>:</p> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>get_resources</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>filters</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
    <span class=n>query</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Resource</span><span class=p>)</span>

    <span class=c1># Apply filters from service layer</span>
    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>filters</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>query</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=nb>getattr</span><span class=p>(</span><span class=n>Resource</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span> <span class=o>==</span> <span class=n>value</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>query</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</code></pre></div> <p><strong>Key Files</strong>:</p> <ul> <li><code>user_repo.py</code> - User database operations</li> <li><code>resource_repo.py</code> - Resource database operations</li> </ul> <h2 id=models-layer>Models Layer<a class=headerlink href=#models-layer title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/models/</code></p> <p><strong>Purpose</strong>: Define database schema</p> <p>Define SQLAlchemy ORM models that map to database tables. Specify relationships and constraints.</p> <p><strong>Example</strong>:</p> <div class=highlight><pre><span></span><code><span class=k>class</span><span class=w> </span><span class=nc>Resource</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;resources&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>unit_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>owner_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&quot;users.id&quot;</span><span class=p>))</span>
    <span class=n>visibility</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&quot;private&quot;</span><span class=p>)</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>JSONB</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>
</code></pre></div> <p><strong>Key Files</strong>:</p> <ul> <li><code>user.py</code> - User model</li> <li><code>resource.py</code> - Resource model</li> </ul> <h2 id=schemas-layer>Schemas Layer<a class=headerlink href=#schemas-layer title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/schemas/</code></p> <p><strong>Purpose</strong>: Validate API input/output</p> <p>Define Pydantic models for request/response validation and serialization. Provide automatic API documentation.</p> <p><strong>Example</strong>:</p> <div class=highlight><pre><span></span><code><span class=k>class</span><span class=w> </span><span class=nc>ResourceCreate</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>unit_id</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>visibility</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;private&quot;</span>
    <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

<span class=k>class</span><span class=w> </span><span class=nc>ResourceRead</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>created_at</span><span class=p>:</span> <span class=n>datetime</span>
</code></pre></div> <p><strong>Key Files</strong>:</p> <ul> <li><code>user.py</code> - User schemas</li> <li><code>resource.py</code> - Resource schemas</li> </ul> <h2 id=core-infrastructure>Core Infrastructure<a class=headerlink href=#core-infrastructure title="Permanent link">&para;</a></h2> <p><strong>Location</strong>: <code>app/core/</code></p> <p><strong>Purpose</strong>: Cross-cutting concerns</p> <p>Handle configuration, security, and logging across the application.</p> <p><strong>Key Files</strong>:</p> <ul> <li><code>config.py</code> - Environment configuration (Pydantic Settings)</li> <li><code>security.py</code> - JWT encoding/decoding, password hashing</li> <li><code>logging.py</code> - Centralized logging setup</li> </ul> <h2 id=request-flow-example>Request Flow Example<a class=headerlink href=#request-flow-example title="Permanent link">&para;</a></h2> <p>Here's how a typical request flows through the layers:</p> <div class=highlight><pre><span></span><code>GET /api/v1/resources
    ↓
[API Layer]
    - Validate JWT token
    - Extract User object
    - Call service layer
    ↓
[Service Layer]
    - Check user permissions
    - Build filters based on user context
    - Call repository
    ↓
[Repository Layer]
    - Build SQL query
    - Apply filters
    - Execute query
    ↓
[Database]
    - Return matching rows
    ↓
[Schema Layer]
    - Serialize to JSON
    ↓
HTTP Response
</code></pre></div> <h2 id=authorization-model>Authorization Model<a class=headerlink href=#authorization-model title="Permanent link">&para;</a></h2> <p>Authorization uses Role-Based Access Control (RBAC) implemented in Python code.</p> <h3 id=roles>Roles<a class=headerlink href=#roles title="Permanent link">&para;</a></h3> <ul> <li><code>admin</code> - Full access to all resources in their unit</li> <li><code>lab_manager</code> - Manage labs and their data</li> <li><code>lab_member</code> - Read/write access to assigned labs</li> <li><code>viewer</code> - Read-only access</li> </ul> <h3 id=permission-checks>Permission Checks<a class=headerlink href=#permission-checks title="Permanent link">&para;</a></h3> <p>Permissions are checked in the service layer:</p> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>update_resource</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
    <span class=n>resource</span> <span class=o>=</span> <span class=n>resource_repo</span><span class=o>.</span><span class=n>get_by_id</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>)</span>

    <span class=c1># Check ownership or admin role</span>
    <span class=k>if</span> <span class=n>resource</span><span class=o>.</span><span class=n>owner_id</span> <span class=o>!=</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>user</span><span class=o>.</span><span class=n>is_admin</span><span class=p>:</span>
        <span class=k>raise</span> <span class=n>PermissionDenied</span><span class=p>(</span><span class=s2>&quot;Cannot update this resource&quot;</span><span class=p>)</span>

    <span class=c1># Proceed with update</span>
    <span class=k>return</span> <span class=n>resource_repo</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</code></pre></div> <h3 id=data-filtering>Data Filtering<a class=headerlink href=#data-filtering title="Permanent link">&para;</a></h3> <p>Users see only resources they have access to:</p> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>get_filters_for_user</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>user</span><span class=o>.</span><span class=n>is_superuser</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{}</span>  <span class=c1># No filters = see all</span>

    <span class=k>if</span> <span class=n>user</span><span class=o>.</span><span class=n>is_admin</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;unit_id&quot;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>unit_id</span><span class=p>}</span>

    <span class=c1># Regular users</span>
    <span class=k>return</span> <span class=p>{</span>
        <span class=s2>&quot;unit_id&quot;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>unit_id</span><span class=p>,</span>
        <span class=s2>&quot;visibility&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;public&quot;</span><span class=p>,</span> <span class=s2>&quot;unit&quot;</span><span class=p>]</span>
    <span class=p>}</span>
</code></pre></div> <h2 id=design-principles>Design Principles<a class=headerlink href=#design-principles title="Permanent link">&para;</a></h2> <h3 id=separation-of-concerns>Separation of Concerns<a class=headerlink href=#separation-of-concerns title="Permanent link">&para;</a></h3> <p>Each layer has one job. API handles HTTP, services handle logic, repositories handle data. Never skip layers.</p> <h3 id=explicit-dependencies>Explicit Dependencies<a class=headerlink href=#explicit-dependencies title="Permanent link">&para;</a></h3> <p>Use FastAPI dependency injection to make dependencies clear:</p> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>endpoint</span><span class=p>(</span>
    <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>),</span>
    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)</span>
<span class=p>):</span>
    <span class=c1># Dependencies are explicit</span>
</code></pre></div> <h3 id=fail-secure>Fail Secure<a class=headerlink href=#fail-secure title="Permanent link">&para;</a></h3> <p>When in doubt, deny access. Better to be too restrictive than too permissive.</p> <h3 id=testability>Testability<a class=headerlink href=#testability title="Permanent link">&para;</a></h3> <p>Each layer can be tested independently with mocks. Services mock repositories, APIs mock services.</p> <h2 id=adding-new-features>Adding New Features<a class=headerlink href=#adding-new-features title="Permanent link">&para;</a></h2> <p>Follow this sequence when adding features:</p> <ol> <li><strong>Define Model</strong> in <code>app/models/</code> - Database schema</li> <li><strong>Create Schemas</strong> in <code>app/schemas/</code> - API validation</li> <li><strong>Build Repository</strong> in <code>app/repositories/</code> - Data access</li> <li><strong>Implement Service</strong> in <code>app/services/</code> - Business logic</li> <li><strong>Add API Endpoints</strong> in <code>app/api/v1/</code> - HTTP interface</li> <li><strong>Write Tests</strong> for each layer</li> </ol> <p>Keep layers clean and respect the separation.</p> <h2 id=common-patterns>Common Patterns<a class=headerlink href=#common-patterns title="Permanent link">&para;</a></h2> <h3 id=create-pattern>Create Pattern<a class=headerlink href=#create-pattern title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># API Layer</span>
<span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/resources&quot;</span><span class=p>)</span>
<span class=k>def</span><span class=w> </span><span class=nf>create_resource</span><span class=p>(</span>
    <span class=n>data</span><span class=p>:</span> <span class=n>ResourceCreate</span><span class=p>,</span>
    <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>),</span>
    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)</span>
<span class=p>):</span>
    <span class=k>return</span> <span class=n>resource_service</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>user</span><span class=p>)</span>

<span class=c1># Service Layer</span>
<span class=k>def</span><span class=w> </span><span class=nf>create</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>ResourceCreate</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
    <span class=c1># Check permissions</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=o>.</span><span class=n>has_permission</span><span class=p>(</span><span class=s2>&quot;resource.create&quot;</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>PermissionDenied</span><span class=p>()</span>

    <span class=c1># Add user context</span>
    <span class=n>data_dict</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>
    <span class=n>data_dict</span><span class=p>[</span><span class=s2>&quot;owner_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span>
    <span class=n>data_dict</span><span class=p>[</span><span class=s2>&quot;unit_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>unit_id</span>

    <span class=k>return</span> <span class=n>resource_repo</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>)</span>

<span class=c1># Repository Layer</span>
<span class=k>def</span><span class=w> </span><span class=nf>create</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
    <span class=n>resource</span> <span class=o>=</span> <span class=n>Resource</span><span class=p>(</span><span class=o>**</span><span class=n>data</span><span class=p>)</span>
    <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
    <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resource</span>
</code></pre></div> <h3 id=list-with-filtering-pattern>List with Filtering Pattern<a class=headerlink href=#list-with-filtering-pattern title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># API Layer</span>
<span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/resources&quot;</span><span class=p>)</span>
<span class=k>def</span><span class=w> </span><span class=nf>list_resources</span><span class=p>(</span>
    <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>),</span>
    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)</span>
<span class=p>):</span>
    <span class=k>return</span> <span class=n>resource_service</span><span class=o>.</span><span class=n>list</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>user</span><span class=p>)</span>

<span class=c1># Service Layer</span>
<span class=k>def</span><span class=w> </span><span class=nf>list</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
    <span class=n>filters</span> <span class=o>=</span> <span class=n>get_filters_for_user</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resource_repo</span><span class=o>.</span><span class=n>list</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>filters</span><span class=o>=</span><span class=n>filters</span><span class=p>)</span>

<span class=c1># Repository Layer</span>
<span class=k>def</span><span class=w> </span><span class=nf>list</span><span class=p>(</span><span class=n>db</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>filters</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
    <span class=n>query</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Resource</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>filters</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
            <span class=n>query</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=nb>getattr</span><span class=p>(</span><span class=n>Resource</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>query</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=nb>getattr</span><span class=p>(</span><span class=n>Resource</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span> <span class=o>==</span> <span class=n>value</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>query</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</code></pre></div> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>The backend uses a five-layer architecture with clear separation of concerns. API handles HTTP, services implement business logic and authorization, repositories handle data access, models define schema, and schemas validate I/O.</p> <p>Authorization happens in the service layer using RBAC. Repositories receive filters and are policy-agnostic.</p> <p>When adding features, follow the layer sequence: model → schema → repository → service → API. Test each layer independently.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 11, 2025 10:45:10 CET">November 11, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Contributors> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg> </span> <nav> <a href=mailto:pierre.guilbert@epfl.ch>Guilbert Pierre</a> </nav> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> 2025 EPFL — GPL-3.0 License. Built with MkDocs </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "content.code.annotate", "navigation.instant", "navigation.instant.prefetch"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "1.0.0"}</script> <script src=../assets/javascripts/bundle.f55a23d4.min.js></script> </body> </html>