# Default values for the CO2 Calculator chart.
# Override these values using a custom values file or --set flags during helm install/upgrade.

nameOverride: ""
fullnameOverride: ""

global:
  imagePullSecrets: []
  # - name: ghcr-creds

backend:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/epfl-enac/epfl/co2-calculator/backend
    tag: "latest"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000
    annotations: {}

  env:
    APP_NAME: "CO2 Calculator API"
    APP_VERSION: "0.1.0"
    DEBUG: "false"
    API_VERSION: "/api/v1"
    API_DOCS_PREFIX: "/api"
    LOG_LEVEL: "INFO"
    ALGORITHM: "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: "30"
    REFRESH_TOKEN_EXPIRE_HOURS: "12"
    PROVIDER_PLUGIN: "default" # Could be 'default' or 'accred' or 'test'
    OAUTH_SCOPE: "openid profile email"
    OAUTH_COOKIE_PATH: "/"
    FRONTEND_URL: "http://localhost:3000" # Change to frontend URL in production
    ACCRED_API_HEALTH_URL: "https://url-you-want-to-check"

  secrets:
    # WARNING: These default values are INSECURE and MUST be overridden before production deployment!
    # Generate a secure key using: openssl rand -hex 32
    # Use backend.existingSecret.enabled=true for production environments
    SECRET_KEY: "" # REQUIRED: Must be set via --set flag or existing secret

    # OAuth/OIDC Configuration (optional, for future OAuth implementation)
    # OAUTH_CLIENT_ID: ""  # OAuth2 client ID from your identity provider
    # OAUTH_CLIENT_SECRET: ""  # OAuth2 client secret (keep secure!)
    # OAUTH_ISSUER_URL: ""  # OIDC issuer URL (e.g., https://keycloak.example.com/realms/your-realm)
    OAUTH_CLIENT_ID: ""
    OAUTH_CLIENT_SECRET: ""
    OAUTH_ISSUER_URL: ""
    OAUTH_TENANT_ID: ""

  podAnnotations: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5

  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  nodeSelector: {}
  tolerations: []
  affinity: {}
  existingSecret:
    enabled: false
    name: "" # Name of the existing secret containing backend secrets
    keys:
      secretKeyKey: SECRET_KEY # Key in the existing secret for SECRET_KEY
      oauthClientIdKey: OAUTH_CLIENT_ID # Key in the existing secret for OAuth client ID
      oauthClientSecretKey: OAUTH_CLIENT_SECRET # Key in the existing secret for OAuth client secret
      oauthIssuerUrlKey: OAUTH_ISSUER_URL # Key in the existing secret for OAuth issuer URL
      oauthTenantIdKey: OAUTH_TENANT_ID # Key in the existing secret for OAuth tenant ID
      accredApiKeyKey: ACCRED_API_KEY # Key in the existing secret for Accred API key
      accredApiUsernameKey: ACCRED_API_USERNAME # Key in the existing secret for Accred API username
      accredApiUrlKey: ACCRED_API_URL # Key in the existing secret for Accred API URL
      filesEncryptionKeyKey: FILES_ENCRYPTION_KEY # Key in the existing secret for files encryption key
      filesEncryptionSaltKey: FILES_ENCRYPTION_SALT # Key in the existing secret for files encryption salt
      filesMaxSizeMbKey: FILES_MAX_SIZE_MB # Key in the existing secret for maximum file size (MB)
      s3EndpointProtocolKey: S3_ENDPOINT_PROTOCOL # Key in the existing secret for S3 endpoint protocol
      s3EndpointHostnameKey: S3_ENDPOINT_HOSTNAME # Key in the existing secret for S3 endpoint hostname
      s3AccessKeyIdKey: S3_ACCESS_KEY_ID # Key in the existing secret for S3 access key ID
      s3SecretAccessKeyKey: S3_SECRET_ACCESS_KEY # Key in the existing secret for S3 secret access key
      s3RegionKey: S3_REGION # Key in the existing secret for S3 region
      s3BucketKey: S3_BUCKET # Key in the existing secret for S3 bucket
      s3PathPrefixKey: S3_PATH_PREFIX # Key in the existing secret for S3 path prefix

  initContainers:
    waitForPostgres:
      resources: # Resources for the wait-for-postgres init container
        limits:
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

  migrations:
    enabled: true # Run database migrations via init container

    resources: # Resources for the migration job container
      limits:
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

    waitForPostgres:
      resources: # Resources for the wait-for-postgres init container
        limits:
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

frontend:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/epfl-enac/epfl/co2-calculator/frontend
    tag: "latest"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 80
    targetPort: 8080
    annotations: {}

  env:
    API_BASE_URL: "/api"

  podAnnotations: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    fsGroup: 101

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8080 # ✅ Match the targetPort
    initialDelaySeconds: 10
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8080 # ✅ Match the targetPort
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  nodeSelector: {}
  tolerations: []
  affinity: {}

# -----------------------------------------------------------------------------
# Database configuration
# External PostgreSQL database (managed separately, e.g., via Bitnami chart)
# -----------------------------------------------------------------------------
database:
  # Secret containing database connection details
  # This secret must contain the following keys:
  #   - DB_URL: Full PostgreSQL connection string (used by backend)
  #     Format: postgresql://user:password@host:port/database
  #   - DB_PASSWORD: Database password (used by Bitnami PostgreSQL chart)
  #
  # These keys map to the Bitnami PostgreSQL chart's existingSecret configuration:
  #   global.postgresql.auth.existingSecret: <name>
  #   global.postgresql.auth.secretKeys.adminPasswordKey: DB_PASSWORD
  #   global.postgresql.auth.secretKeys.userPasswordKey: DB_PASSWORD
  existingSecret:
    name: "db-secret"
    keys:
      # use for backend and migrations job
      url: DB_URL
      # use for bitnami/postgresql chart
      password: DB_PASSWORD

  # Wait for PostgreSQL readiness before starting backend/migrations
  waitForPostgres:
    enabled: true
    image:
      repository: bitnamilegacy/postgresql
      tag: "latest"
      pullPolicy: IfNotPresent

ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
  hosts:
    # Simple mode - just specify hostname(s), paths are auto-configured
    - co2-calculator.local
    # Or use multiple hosts:
    # - co2-calculator.local
    # - co2-calculator.example.com

    # Advanced mode - full control over paths (optional)
    # - host: co2-calculator.local
    #   paths:
    #     - path: /api
    #       pathType: Prefix
    #       backend: backend
    #     - path: /
    #       pathType: Prefix
    #       backend: frontend
  tls: []

# OpenShift Routes configuration
routes:
  enabled: false
  host: "co2-calculator.local"
  frontend:
    extraLabels: {}
    annotations: {}
    weight: 100
    tls:
      termination: edge

  backend:
    extraLabels: {}
    annotations: {}
    weight: 100
    tls:
      termination: edge

serviceAccount:
  create: true
  annotations: {}
  name: ""

podDisruptionBudget:
  enabled: false
  minAvailable: 1
  maxUnavailable: ""

networkPolicy:
  enabled: false
  ingress: []
