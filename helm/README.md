# CO2 Calculator Helm Chart

This chart deploys the CO2 Calculator platform consisting of a FastAPI backend, a Quasar frontend, and an optional PgBouncer connection pooler. It assumes an external PostgreSQL instance but documents how to attach a sidecar database when required.

## Prerequisites

- Kubernetes 1.24+
- Helm 3.8+
- External PostgreSQL database URL (unless attaching the optional sidecar)
- Ingress controller when `ingress.enabled=true`

## Quick Start

```bash
# Review and adapt values
cp values.yaml values.local.yaml
# Replace database credentials, secret key, hosts, etc. in values.local.yaml

helm upgrade --install co2-calculator ./helm -f values.local.yaml
```

## Architecture Highlights

- **Backend**: FastAPI application exposing the API on port 8000.
- **Frontend**: Nginx-served Quasar build exposing the UI on port 80.
- **Ingress**: Routes `/api` traffic to the backend and all other paths to the frontend.
- **Database**: External PostgreSQL connection provided through `database.external` or an external secret.
- **PgBouncer (optional)**: Lightweight connection pooler that the backend can target when `pgbouncer.enabled=true`.

## Configuration Overview

Key sections in `values.yaml` map directly to the environment variables defined in `backend/.env.example` and runtime needs for the frontend:

- `backend.env`: Maps to `APP_NAME`, `API_V1_PREFIX`, `LOG_LEVEL`, `OPA_*`, and security values such as `ALGORITHM`.
- `backend.secrets.SECRET_KEY`: Mirrors the required `SECRET_KEY` in the backend `.env`. Override with a secure value.
- `database.external`: Provides the duplicate `DATABASE_URL`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, and `POSTGRES_DB` entries expected by the backend.
- `frontend.env.API_BASE_URL`: Allows the UI to target the API path exposed through the ingress.

### Database Input Options

1. **Direct URL** – Set `database.external.url` to the full SQLAlchemy connection string.
2. **Component fields** – Populate `database.external.host`, `port`, `username`, `password`, and `database`. The chart will assemble the URL automatically.
3. **External secret** – Point `database.externalSecret` and `backend.externalSecret` to a pre-existing Kubernetes secret containing `DATABASE_URL`, `POSTGRES_USER`, and `POSTGRES_PASSWORD` keys.

### PgBouncer

Enable the connection pooler and retarget the backend to it:

```yaml
pgbouncer:
  enabled: true
  replicaCount: 2

backend:
  secrets:
    SECRET_KEY: "override-me"
```

When PgBouncer is enabled the autogenerated secret rewrites `DATABASE_URL` so the backend speaks to PgBouncer instead of the raw database host.

### Autoscaling

Set `backend.autoscaling.enabled` or `frontend.autoscaling.enabled` to `true` and adjust `targetCPUUtilizationPercentage`/`targetMemoryUtilizationPercentage` for HPA resources. When disabled the chart relies on the static `replicaCount` values.

### Ingress

- Update `ingress.hosts[*].host` with your domain names.
- Provide TLS secrets through `ingress.tls`.
- Adjust annotations to match your ingress controller (default assumes NGINX).

## Adding a Sidekick PostgreSQL

See `POSTGRESQL_SIDECAR.md` for detailed options leveraging Bitnami PostgreSQL or CloudNativePG to run a database in the same cluster. The guide walks through installation, secret creation, and the values required to connect the CO2 Calculator chart to the sidecar instance.

## Operations Checklist

- Rotate `SECRET_KEY`, database credentials, and TLS material through secrets management.
- Enable resource requests and limits as per production sizing.
- Consider NetworkPolicies (`networkPolicy.enabled=true`) when the cluster enforces strict pod communication.
- Attach observability by adding Prometheus scrape annotations to `backend.podAnnotations` if `/metrics` exposure is configured.
